<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TonyOS – Command Board</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      /* DARK MODE DEFAULTS */
      --bg: #020817;
      --bg-elevated: #040b1d;
      --bg-card: #050f21;
      --bg-card-soft: #07142b;
      --border-subtle: rgba(148, 163, 184, 0.25);
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.08);
      --accent-strong: #0ea5e9;
      --critical: #f97373;
      --high: #fbbf24;
      --text: #e5f0ff;
      --text-soft: #9ca3af;
      --muted: #6b7280;
      --radius-lg: 18px;
      --radius-md: 12px;
      --shadow-soft: 0 24px 60px rgba(15, 23, 42, 0.75);
      --shadow-tiny: 0 0 0 1px rgba(148, 163, 184, 0.2);
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #0b1220, #020617 55%, #020617);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
    }

    body {
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 16px;
    }

    .app-shell {
      width: 100%;
      max-width: 1320px;
      height: 100%;
      max-height: 840px;
      background: radial-gradient(circle at top left, #020617, #000000 60%);
      border-radius: 26px;
      padding: 18px 18px 18px;
      box-shadow:
        0 0 0 1px rgba(148, 163, 184, 0.3),
        0 40px 120px rgba(15, 23, 42, 0.9);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* TOP BAR */

    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 8px 4px 16px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.25);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-icon {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: conic-gradient(
        from 200deg,
        #38bdf8,
        #0ea5e9,
        #22c55e,
        #38bdf8
      );
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.7),
        0 0 40px rgba(56, 189, 248, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #020617;
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .brand-meta {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .brand-title {
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #e5f0ff;
    }

    .brand-subtitle {
      font-size: 12px;
      color: var(--muted);
    }

    .top-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .pill {
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.4);
      font-size: 11px;
      color: var(--text-soft);
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.8);
    }

    .pill-label {
      text-transform: uppercase;
      letter-spacing: 0.14em;
      font-weight: 600;
      color: #e5f0ff;
    }

    .pill-value {
      font-weight: 500;
      color: var(--text-soft);
    }

    .primary-chip {
      padding: 8px 16px;
      border-radius: 999px;
      border: 1px solid rgba(56,189,248,0.6);
      background: radial-gradient(circle at top left, rgba(56,189,248,0.18), rgba(15,23,42,0.9));
      color: #e0f2fe;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 0 40px rgba(56,189,248,0.45);
    }

    .primary-chip span:first-child {
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      font-size: 11px;
    }

    .primary-chip span:last-child {
      color: #bae6fd;
      font-weight: 500;
    }

    /* MAIN LAYOUT */

    .main-layout {
      flex: 1;
      display: grid;
      grid-template-columns: minmax(0, 2.2fr) minmax(0, 1.3fr);
      gap: 16px;
      padding-top: 14px;
      overflow: hidden;
    }

    @media (max-width: 1024px) {
      .app-shell {
        max-height: none;
        height: auto;
      }

      .main-layout {
        grid-template-columns: minmax(0, 1fr);
        grid-auto-rows: auto;
        overflow-y: auto;
      }
    }

    /* LEFT COLUMN – BOARD */

    .panel {
      background: radial-gradient(circle at top left, #020617, #020617 55%, #000000);
      border-radius: 20px;
      padding: 16px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 0;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .panel-title-wrap {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .panel-kicker {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--muted);
      font-weight: 600;
    }

    .panel-title {
      font-size: 20px;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #f9fafb;
    }

    .panel-subtitle {
      font-size: 12px;
      color: var(--text-soft);
    }

    .panel-right {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-end;
    }

    .micro-kpi {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      align-items: baseline;
      gap: 4px;
    }

    .micro-kpi strong {
      font-size: 16px;
      color: #e5f0ff;
    }

    .board-grid {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      min-height: 0;
    }

    @media (max-width: 1200px) {
      .board-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 900px) {
      .board-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .lane {
      background: radial-gradient(circle at top left, #020617, #020617 60%, #020617);
      border-radius: 16px;
      padding: 10px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: var(--shadow-tiny);
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
    }

    .lane-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .lane-title {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #f9fafb;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .lane-title-badge {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 10px rgba(56, 189, 248, 0.9);
    }

    .lane-meta {
      font-size: 11px;
      color: var(--muted);
    }

    .lane-body {
      flex: 1;
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .empty-state {
      font-size: 12px;
      color: var(--muted);
      padding: 10px;
      border-radius: 12px;
      border: 1px dashed rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.7);
    }

    /* TASK CARD */

    .task-card {
      background: radial-gradient(circle at top left, #020617, #020617 65%, #020617);
      border-radius: 12px;
      padding: 10px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.8);
      display: flex;
      flex-direction: column;
      gap: 6px;
      cursor: default;
      transition: transform 0.1s ease, box-shadow 0.1s ease, border-color 0.1s ease;
    }

    .task-card:hover {
      transform: translateY(-2px);
      border-color: rgba(56, 189, 248, 0.75);
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.95),
        0 0 20px rgba(56, 189, 248, 0.28);
    }

    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
    }

    .task-title {
      font-size: 13px;
      font-weight: 600;
      color: #f9fafb;
    }

    .task-meta-row {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 11px;
    }

    .task-area {
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: var(--text-soft);
    }

    .task-priority {
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      border: 1px solid rgba(148, 163, 184, 0.6);
    }

    .task-priority[data-level="1"] {
      border-color: rgba(248, 113, 113, 0.9);
      color: #fecaca;
      box-shadow: 0 0 12px rgba(248, 113, 113, 0.7);
    }

    .task-priority[data-level="2"] {
      border-color: rgba(251, 191, 36, 0.9);
      color: #fef3c7;
    }

    .task-priority[data-level="3"] {
      border-color: rgba(52, 211, 153, 0.9);
      color: #bbf7d0;
    }

    .task-status-pill {
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #e5e7eb;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.7);
    }

    .task-status-pill[data-status="doing"] {
      border-color: rgba(56, 189, 248, 0.9);
      color: #bae6fd;
      box-shadow: 0 0 10px rgba(56, 189, 248, 0.7);
    }

    .task-status-pill[data-status="done"] {
      border-color: rgba(52, 211, 153, 0.9);
      color: #bbf7d0;
      text-decoration: line-through;
    }

    .task-body {
      font-size: 11px;
      color: var(--text-soft);
      line-height: 1.4;
    }

    .task-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-top: 4px;
    }

    .task-due {
      font-size: 11px;
      color: var(--muted);
    }

    .task-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      justify-content: flex-end;
    }

    .btn {
      border-radius: 999px;
      padding: 3px 9px;
      font-size: 11px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-soft);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.15s ease, border-color 0.15s ease, color 0.15s ease,
        transform 0.08s ease;
    }

    .btn:hover {
      background: rgba(15, 23, 42, 1);
      border-color: rgba(56, 189, 248, 0.9);
      color: #e0f2fe;
      transform: translateY(-1px);
    }

    .btn-primary {
      border-color: rgba(56, 189, 248, 0.9);
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.3), rgba(15, 23, 42, 1));
      color: #e0f2fe;
      box-shadow: 0 0 14px rgba(56, 189, 248, 0.6);
    }

    .btn-primary:hover {
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.45), rgba(15, 23, 42, 1));
    }

    /* RIGHT COLUMN – SNAPSHOT / CONSOLE */

    .side-panel {
      background: radial-gradient(circle at top left, #020617, #000000 55%);
      border-radius: 20px;
      padding: 16px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      gap: 14px;
      min-height: 0;
    }

    .side-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .side-title {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #f9fafb;
    }

    .side-subtitle {
      font-size: 11px;
      color: var(--text-soft);
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    .kpi-card {
      border-radius: 14px;
      padding: 10px;
      background: radial-gradient(circle at top left, #020617, #020617 55%, #020617);
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: var(--shadow-tiny);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .kpi-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
    }

    .kpi-value {
      font-size: 18px;
      font-weight: 600;
      color: #e5f0ff;
    }

    .kpi-footnote {
      font-size: 11px;
      color: var(--text-soft);
    }

    .console {
      flex: 1;
      border-radius: 14px;
      padding: 10px;
      background: radial-gradient(circle at top left, #020617, #020617 55%, #020617);
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: var(--shadow-tiny);
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
      overflow: hidden;
    }

    .console-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
    }

    .console-log {
      flex: 1;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(30, 64, 175, 0.8);
      padding: 8px;
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      color: #cbd5f5;
      overflow-y: auto;
    }

    .console-line {
      display: flex;
      gap: 6px;
      margin-bottom: 2px;
    }

    .console-line-prefix {
      color: #4b5563;
      flex-shrink: 0;
    }

    .console-line-text {
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    .console-input-row {
      display: flex;
      gap: 6px;
      margin-top: 4px;
    }

    .console-input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.95);
      padding: 6px 12px;
      font-size: 12px;
      color: var(--text);
      outline: none;
    }

    .console-input::placeholder {
      color: var(--muted);
    }

    .console-run-btn {
      border-radius: 999px;
      border: 1px solid rgba(56, 189, 248, 0.9);
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.35), rgba(15, 23, 42, 1));
      padding: 6px 14px;
      font-size: 12px;
      color: #e0f2fe;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .console-run-btn:hover {
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.5), rgba(15, 23, 42, 1));
    }

    .badge {
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 10px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .badge-hot {
      border-color: rgba(248, 113, 113, 0.9);
      color: #fecaca;
      box-shadow: 0 0 10px rgba(248, 113, 113, 0.7);
    }

    .badge-calm {
      border-color: rgba(52, 211, 153, 0.9);
      color: #bbf7d0;
    }

    /* LOADING & ERROR */

    .loading,
    .error {
      font-size: 12px;
      color: var(--muted);
      padding: 6px 0;
    }

    .error {
      color: #fecaca;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- TOP BAR -->
    <header class="top-bar">
      <div class="brand">
        <div class="brand-icon">T</div>
        <div class="brand-meta">
          <div class="brand-title">TonyOS Command Board</div>
          <div class="brand-subtitle">Turn ideas into action automatically.</div>
        </div>
      </div>
      <div class="top-actions">
        <div class="pill">
          <div class="pill-dot"></div>
          <span class="pill-label">System</span>
          <span class="pill-value" id="board-status-label">Online</span>
        </div>
        <div class="pill">
          <span class="pill-label">Focus Window</span>
          <span class="pill-value" id="focus-window-label">Next 24–72 Hours</span>
        </div>
        <div class="primary-chip">
          <span>Today’s Target</span>
          <span id="primary-target-label">Ship 3 highest-leverage moves.</span>
        </div>
      </div>
    </header>

    <!-- MAIN -->
    <main class="main-layout">
      <!-- LEFT: BOARD -->
      <section class="panel">
        <div class="panel-header">
          <div class="panel-title-wrap">
            <div class="panel-kicker">Execution Board</div>
            <div class="panel-title">Where should my energy go next?</div>
            <div class="panel-subtitle">
              Tony-only board. Hard limit: 3 highest-leverage moves in the immediate window.
            </div>
          </div>
          <div class="panel-right">
            <div class="micro-kpi">
              <span>Today queued:</span>
              <strong id="kpi-today-count">0</strong>
            </div>
            <div class="micro-kpi">
              <span>In motion:</span>
              <strong id="kpi-doing-count">0</strong>
            </div>
          </div>
        </div>

        <div id="board-loading" class="loading">Loading tasks from backend…</div>
        <div id="board-error" class="error" style="display:none;">Error loading tasks. Check server.</div>

        <div class="board-grid" id="board-grid" style="display:none;">
          <!-- Lane: Next 24–72 Hrs -->
          <div class="lane" data-lane="today">
            <div class="lane-header">
              <div class="lane-title">
                <span class="lane-title-badge"></span>
                <span>Next 24–72 Hrs</span>
              </div>
              <div class="lane-meta">
                Max <strong>3</strong> cards. No excuses.
              </div>
            </div>
            <div class="lane-body" id="lane-today"></div>
          </div>

          <!-- Lane: This Week -->
          <div class="lane" data-lane="this_week">
            <div class="lane-header">
              <div class="lane-title">
                <span class="lane-title-badge"></span>
                <span>This Week</span>
              </div>
              <div class="lane-meta">
                Pull from here when “Today” is clear.
              </div>
            </div>
            <div class="lane-body" id="lane-this_week"></div>
          </div>

          <!-- Lane: Later / Backlog -->
          <div class="lane" data-lane="later">
            <div class="lane-header">
              <div class="lane-title">
                <span class="lane-title-badge"></span>
                <span>Later & Backlog</span>
              </div>
              <div class="lane-meta">
                Park long-horizon or non-critical work.
              </div>
            </div>
            <div class="lane-body" id="lane-later"></div>
          </div>
        </div>
      </section>

      <!-- RIGHT: SNAPSHOT / CONSOLE -->
      <aside class="side-panel">
        <div class="side-header">
          <div>
            <div class="side-title">System Snapshot</div>
            <div class="side-subtitle">Quick read on your command board health.</div>
          </div>
          <div class="badge badge-hot" id="load-badge">Live</div>
        </div>

        <div class="kpi-grid">
          <div class="kpi-card">
            <div class="kpi-label">Total Open Tasks</div>
            <div class="kpi-value" id="kpi-total-open">0</div>
            <div class="kpi-footnote" id="kpi-total-open-note">Across all buckets.</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Done (Today)</div>
            <div class="kpi-value" id="kpi-done-today">0</div>
            <div class="kpi-footnote" id="kpi-done-today-note">Shipped in this session.</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Immediate Load</div>
            <div class="kpi-value" id="kpi-load-score">0</div>
            <div class="kpi-footnote" id="kpi-load-footnote">Target: 3 or less in “Next 24–72 Hrs”.</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Focus Confidence</div>
            <div class="kpi-value" id="kpi-focus-score">100%</div>
            <div class="kpi-footnote">Subjective: 3 cards max = clarity.</div>
          </div>
        </div>

        <div class="console">
          <div class="console-label">Activity Log</div>
          <div class="console-log" id="console-log">
            <!-- Lines injected here -->
          </div>
          <div class="console-input-row">
            <input
              id="console-input"
              class="console-input"
              placeholder='Quick note or command (e.g. "Mark everything not critical as backlog")'
            />
            <button class="console-run-btn" id="console-run-btn">
              Run
            </button>
          </div>
        </div>
      </aside>
    </main>
  </div>

  <script>
    // ===== BASIC CONFIG =====
    const API_BASE = ""; // same origin. If different: "http://localhost:3000"
    const BOARD_ENDPOINT = API_BASE + "/tasks/board";
    const TASK_UPDATE_ENDPOINT = (id) => API_BASE + "/tasks/" + id;

    let doneTodayCount = 0;

    // ===== DOM HELPERS =====
    const qs = (sel) => document.querySelector(sel);

    function logLine(text) {
      const log = qs("#console-log");
      if (!log) return;
      const line = document.createElement("div");
      line.className = "console-line";
      const prefix = document.createElement("span");
      prefix.className = "console-line-prefix";
      const timestamp = new Date().toLocaleTimeString("en-US", {
        hour: "2-digit",
        minute: "2-digit"
      });
      prefix.textContent = "[" + timestamp + "]";
      const body = document.createElement("span");
      body.className = "console-line-text";
      body.textContent = text;
      line.appendChild(prefix);
      line.appendChild(body);
      log.appendChild(line);
      log.scrollTop = log.scrollHeight;
    }

    function formatDueDate(due) {
      if (!due) return "No due date";
      const d = new Date(due);
      if (Number.isNaN(d.getTime())) return due;
      return d.toLocaleDateString("en-US", {
        month: "short",
        day: "numeric"
      });
    }

    // ===== RENDER TASK CARD =====
    function createTaskCard(task) {
      const card = document.createElement("article");
      card.className = "task-card";

      const header = document.createElement("div");
      header.className = "task-header";

      const titleEl = document.createElement("div");
      titleEl.className = "task-title";
      titleEl.textContent = task.title || "Untitled Task";

      const statusPill = document.createElement("div");
      statusPill.className = "task-status-pill";
      statusPill.dataset.status = task.status || "todo";
      statusPill.textContent = (task.status || "todo").toUpperCase();

      header.appendChild(titleEl);
      header.appendChild(statusPill);

      const metaRow = document.createElement("div");
      metaRow.className = "task-meta-row";

      if (task.area) {
        const area = document.createElement("span");
        area.className = "task-area";
        area.textContent = task.area;
        metaRow.appendChild(area);
      }

      const priority = document.createElement("span");
      priority.className = "task-priority";
      priority.dataset.level = String(task.priority || 3);
      const p = task.priority || 3;
      const label =
        p === 1 ? "Critical" :
        p === 2 ? "High" :
        "Normal";
      priority.textContent = label;
      metaRow.appendChild(priority);

      const body = document.createElement("div");
      body.className = "task-body";
      body.textContent = task.description || "";

      const footer = document.createElement("div");
      footer.className = "task-footer";

      const due = document.createElement("div");
      due.className = "task-due";
      due.textContent = "Due: " + formatDueDate(task.due_date);

      const actions = document.createElement("div");
      actions.className = "task-actions";

      const btnDo = document.createElement("button");
      btnDo.className = "btn btn-primary";
      btnDo.textContent = "Start";
      btnDo.addEventListener("click", () =>
        updateTask(task.id, { status: "doing" })
      );

      const btnDone = document.createElement("button");
      btnDone.className = "btn";
      btnDone.textContent = "Done";
      btnDone.addEventListener("click", () =>
        updateTask(task.id, { status: "done" })
      );

      const btnBacklog = document.createElement("button");
      btnBacklog.className = "btn";
      btnBacklog.textContent = "Backlog";
      btnBacklog.addEventListener("click", () =>
        updateTask(task.id, { bucket: "backlog", status: "todo" })
      );

      actions.appendChild(btnDo);
      actions.appendChild(btnDone);
      actions.appendChild(btnBacklog);

      footer.appendChild(due);
      footer.appendChild(actions);

      card.appendChild(header);
      card.appendChild(metaRow);
      if (task.description) card.appendChild(body);
      card.appendChild(footer);

      return card;
    }

    // ===== UPDATE BACKEND =====
    async function updateTask(id, updates) {
      try {
        logLine(">> Updating task #" + id + " " + JSON.stringify(updates));
        const res = await fetch(TASK_UPDATE_ENDPOINT(id), {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(updates)
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        if (updates.status === "done") {
          doneTodayCount += 1;
          qs("#kpi-done-today").textContent = String(doneTodayCount);
          qs("#kpi-done-today-note").textContent = "Since this page loaded.";
        }
        await loadBoard();
      } catch (err) {
        logLine("!! Error updating task: " + err.message);
        alert("Error updating task. Check console/server.");
      }
    }

    // ===== LOAD & RENDER BOARD =====
    async function loadBoard() {
      const loading = qs("#board-loading");
      const error = qs("#board-error");
      const boardGrid = qs("#board-grid");

      loading.style.display = "block";
      error.style.display = "none";
      boardGrid.style.display = "none";

      // clear lanes
      ["today", "this_week", "later"].forEach((laneKey) => {
        const laneBody = qs("#lane-" + laneKey);
        if (laneBody) laneBody.innerHTML = "";
      });

      try {
        const res = await fetch(BOARD_ENDPOINT);
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        loading.style.display = "none";
        boardGrid.style.display = "grid";

        const buckets = {
          today: data.today || data.today || [],
          this_week: data.this_week || data.thisWeek || [],
          later: (data.later || []).concat(data.backlog || [])
        };

        // enforce 3-task limit visually for today
        const todayTasks = buckets.today.slice(0, 3);
        const overflowCount = (buckets.today.length || 0) - todayTasks.length;

        // Render lanes
        let totalOpen = 0;
        let doingCount = 0;

        Object.entries(buckets).forEach(([key, tasks]) => {
          const laneBody = qs("#lane-" + key);
          if (!laneBody) return;

          if (!tasks || tasks.length === 0) {
            const empty = document.createElement("div");
            empty.className = "empty-state";
            empty.textContent =
              key === "today"
                ? "No cards here. Pull one in from This Week or Later—don’t manufacture fake work."
                : "Nothing parked here yet.";
            laneBody.appendChild(empty);
            return;
          }

          const list =
            key === "today"
              ? todayTasks
              : tasks;

          list.forEach((task) => {
            if (task.status !== "done") totalOpen += 1;
            if (task.status === "doing") doingCount += 1;
            laneBody.appendChild(createTaskCard(task));
          });

          if (key === "today" && overflowCount > 0) {
            const warning = document.createElement("div");
            warning.className = "empty-state";
            warning.style.borderColor = "rgba(248,113,113,0.8)";
            warning.style.color = "#fecaca";
            warning.textContent =
              "You have " +
              overflowCount +
              " extra tasks in this bucket. Hard rule: cap visible cards to 3.";
            laneBody.appendChild(warning);
          }
        });

        // KPIs
        qs("#kpi-today-count").textContent = todayTasks.length.toString();
        qs("#kpi-doing-count").textContent = doingCount.toString();
        qs("#kpi-total-open").textContent = totalOpen.toString();

        const loadScore = todayTasks.length;
        qs("#kpi-load-score").textContent = String(loadScore);
        qs("#kpi-load-footnote").textContent =
          loadScore <= 3
            ? "You're within the load range. Ship these before pulling more in."
            : "You’re over capacity. Trim this lane down.";

        // status badge
        const badge = qs("#load-badge");
        if (loadScore > 3) {
          badge.textContent = "Overloaded";
          badge.classList.remove("badge-calm");
          badge.classList.add("badge-hot");
        } else {
          badge.textContent = "Live";
          badge.classList.remove("badge-hot");
          badge.classList.add("badge-calm");
        }

        logLine("OK Loaded board: " + totalOpen + " open, " + doingCount + " in motion.");
      } catch (err) {
        loading.style.display = "none";
        error.style.display = "block";
        logLine("!! Error loading board: " + err.message);
      }
    }

    // ===== CONSOLE INPUT (LOCAL ONLY FOR NOW) =====
    function setupConsoleInput() {
      const input = qs("#console-input");
      const btn = qs("#console-run-btn");
      if (!input || !btn) return;

      function run() {
        const value = input.value.trim();
        if (!value) return;
        logLine(">> " + value);
        // Hook: This is where you'd POST to an /ai/command endpoint later.
        input.value = "";
      }

      btn.addEventListener("click", run);
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          run();
        }
      });
    }

    // ===== INIT =====
    window.addEventListener("DOMContentLoaded", () => {
      logLine("TonyOS Command Board booted.");
      setupConsoleInput();
      loadBoard();
      // Optional: auto-refresh every few minutes
      // setInterval(loadBoard, 1000 * 60 * 3);
    });
  </script>
</body>
</html>
